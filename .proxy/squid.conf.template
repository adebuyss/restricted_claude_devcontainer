# Squid Proxy Configuration for Claude Code Devcontainer
# Allowlist-based filtering for outbound HTTP/HTTPS traffic

# ============================================
# BASIC SETTINGS
# ============================================
http_port 3128

# Logging
access_log stdio:/var/log/squid/access.log squid
cache_log stdio:/var/log/squid/cache.log

# Disable caching (keeps things simple, enable if needed for performance)
cache deny all

# Visible hostname for error pages
visible_hostname claude-proxy

# ============================================
# ACL DEFINITIONS
# ============================================

# Standard ports
acl SSL_ports port 443
acl SSL_ports port 22        # Allow CONNECT to SSH for git
acl Safe_ports port 80       # HTTP
acl Safe_ports port 443      # HTTPS
acl Safe_ports port 22       # SSH (for git over SSH via CONNECT)
acl CONNECT method CONNECT

# Local network (for internal container communication)
acl localnet src 10.0.0.0/8
acl localnet src 172.16.0.0/12
acl localnet src 192.168.0.0/16

# ============================================
# ALLOWLIST - Load from file
# ============================================
acl allowed_domains dstdomain "/etc/squid/allowlist.txt"

# ============================================
# ACCESS RULES (ORDER MATTERS!)
# ============================================

# Deny requests to unsafe ports
http_access deny !Safe_ports

# Deny CONNECT to non-SSL ports (except SSH)
http_access deny CONNECT !SSL_ports

# Allow localhost
http_access allow localhost

# Allow connections to allowlisted domains only
http_access allow allowed_domains

# Deny everything else
http_access deny all

# ============================================
# SECURITY HARDENING
# ============================================

# Don't reveal internal network info
forwarded_for delete
via off

# Don't reveal Squid version
httpd_suppress_version_string on

# Limit request sizes
request_header_max_size 64 KB
request_body_max_size 0

# Connection timeouts
connect_timeout 30 seconds
read_timeout 60 seconds
request_timeout 60 seconds
client_lifetime 1 hour
pconn_timeout 30 seconds

# ============================================
# UPSTREAM PROXY (Corporate Proxy Chaining)
# ============================================
# This section is dynamically generated by entrypoint.sh
# If UPSTREAM_PROXY is set, traffic is forwarded to corporate proxy
# @@UPSTREAM_PROXY_CONFIG@@

# ============================================
# PERFORMANCE
# ============================================
workers 2

# Quick shutdown
shutdown_lifetime 3 seconds
